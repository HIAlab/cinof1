---
title: "Example Use"
author: "Thomas Gaertner"
date: "4/13/2021"
output: pdf_document
---

```{r setup, include=FALSE}
devtools::document()
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This R Markdown document shows the usage of the package `cino1`. 

```{r, warnings=FALSE}
# Install local package
install.packages("~/Documents/Masterarbeit/Package/nofone/", repos = NULL, type="source")
# load package
library(cinof1)
```


## Data

In this package, a sample data frame is included. It contains data for 300 patients within an n of 1 study. The data has the following structure:

* _patient_id_: Unique patient identifier
* _date_: Date of data points
* _day_: Day in study
* _Block_: identifies treatment block
* _Activity_: Dummy variable for steps per day
* _treatment_: Dummy variable for 2 treatments as factors
* _Uncertain_Low_Back_Pain_: Dummy variable for Uncertain loq back pain on scale 1-15

```{r data}
load("data/simpatdat.rda")
# Summarize Data
summary(simpatdat)
```

## Basic Analysis

Basic functions for analyse N-of-1 studys are for example wilcox test or comparative plots. These two functions are provided in this package.

```{r basic function comparativ plot}
# Define outcome and exposure column
outcome <- "Uncertain_Low_Back_Pain"
exposure <- "treatment"
# Plot outcome among different exposures
comparative.plot(simpatdat, exposure = exposure, outcome = outcome)
```

```{r basic function wilcox testt}
# Define outcome and exposure column
outcome <- "Uncertain_Low_Back_Pain"
exposure <- "treatment"
# Perform Wilcox test among different exposures
wilcox.nofone(simpatdat, exposure = exposure, outcome = outcome)
```

## Bayesian

### Dag
```{r}
id <- "patient_id"
time_col <- "day"

ex.dag <- dagitty("dag{treatment.lag_1 -> Activity.lag_1 -> Uncertain_Low_Back_Pain; treatment -> Uncertain_Low_Back_Pain}")
#usethis::use_data(ex.dag, internal=FALSE, overwrite = TRUE)
#plot(ex.dag)

#load("data/ex.dag.rda")
load("data/simpatdat.rda")

# Data Preprocessing
simpatdat <- simpatdat[simpatdat$patient_id>290,]
simpatdat$Uncertain_Low_Back_Pain <- as.factor(simpatdat$Uncertain_Low_Back_Pain)
simpatdat$Activity <- cut(simpatdat$Activity, 3, labels=c("low Activity", "middle Activity", "high Activity"))

bn.dag <- bn.prep.dag(ex.dag)

bn.data <- bn.prep.data(bn.dag, simpatdat, id, time_col)
bn.data <- na.omit(bn.data)
fitted.bn <- bn.fit.dag(bn.data, bn.dag, method="bayes")
fitted.bn <- bn.fit(bn.dag$dag, bn.data, method = "mle")
bn.fit.barchart(fitted.bn$Uncertain_Low_Back_Pain)

```
## G-Estimation

```{r g-estimation}
data <- simpatdat[simpatdat$patient_id>195,]
data <- data[data$patient_id<205,]
outcome <- "Uncertain_Low_Back_Pain"
exposure <- "treatment"
confounder <- c("Activity")
id <- "patient_id"
df <- nofgest(data, outcome, exposure, confounder, id, method="iterate", steps=100, upper_bound_psi = 10, lower_bound_psi = -10)
```


```{r}
plot(df , type="l", main=expression(paste("Plot of ", alpha, "( ", psi,")")),
        xlab=expression(psi),
        ylab=expression(alpha))
# Add a second line
lines( c(-100,100),c(0,0), type = "l", col = "red")
```


```{r}

data <- simpatdat[simpatdat$patient_id>195,]
data <- data[data$patient_id<205,]
outcome <- "Uncertain_Low_Back_Pain"
exposure <- "treatment"
confounder <- c("Activity")
id <- "patient_id"
nofgest(data, outcome, exposure, confounder, id, method="rec_mean", new_psi)
```

```{r}
data <- simpatdat[simpatdat$patient_id>195,]
data <- data[data$patient_id<205,]
outcome <- "Uncertain_Low_Back_Pain"
exposure <- "treatment"
confounder <- c("Activity")
id <- "patient_id"
nofgest(data, outcome, exposure, confounder, id, method="rec", new_psi)
```
```{r}
it_mean <- 0 
for(i in c(1,2,4,6)){
  for(shift in seq(from=-i+(1/2*i), to=i-(1/2*i),length.out=10)){
    res <- nofgest(data, outcome, exposure, confounder, id, method="rec", upper_bound_psi = i-shift, lower_bound_psi = -i-shift)
    it_mean <- it_mean + res$n_it
  }
  print(paste("Mean it for i=",i,": ",it_mean/10))
  it_mean <- 0
}
```

```{r}
it_mean <- 0 
for(i in c(1,2,4,6)){
  for(shift in seq(from=-i+(1/2*i), to=i-(1/2*i),length.out=10)){
    res <- nofgest(data, outcome, exposure, confounder, id, method="rec_mean", upper_bound_psi = i-shift, lower_bound_psi = -i-shift)
    it_mean <- it_mean + res$n_it
  }
  print(paste("Mean it for i=",i,": ",it_mean/10))
  it_mean <- 0
}
```
```{r}


```

